# 回调函数中发布 MQTT 消息示例

## 功能描述

本示例演示如何在回调函数中发布 MQTT 消息。当在订阅的 "inTopic" 上接收到消息时，会自动将其重新发布到 "outTopic"。这种模式适用于创建消息中继系统、数据转发或实现简单的基于 MQTT 的通信协议。

## 硬件要求

- 任意具有 WiFi 功能的涂鸦支持开发板（T2、T3、T5、ESP32 或 XH_WB5E）
- WiFi 网络连接
- 访问 MQTT 代理服务器（示例使用 broker.emqx.io）

## 使用说明

1. 在 Arduino IDE 中打开本示例
2. 修改 WiFi 凭据：
   ```cpp
   const char* ssid = "your_ssid";
   const char* password = "your_passwd";
   ```
3. 可选修改 MQTT 代理服务器设置：
   - `mqtt_server`: MQTT 代理服务器地址
   - `mqtt_username`: MQTT 用户名
   - `mqtt_password`: MQTT 密码
4. 从工具 > 开发板菜单选择您的涂鸦开发板
5. 上传程序到开发板
6. 打开串口监视器，波特率设置为 115200
7. 向 "inTopic" 发送消息，观察它被重新发布到 "youroutTopic"

## 代码功能要点

- **WiFi 连接**：连接到 WiFi 并显示连接状态
- **MQTT 重连**：如果连接断开，自动重新连接到 MQTT 代理服务器
- **消息转发**：接收消息并将其重新发布到不同的主题
- **回调中发布**：演示在回调函数中安全地发布消息
- **调试日志**：使用 Log 库进行调试级别的日志记录（设置为 DEBUG 级别）

## 回调函数

`mqtt_message_cb` 回调函数：
1. 在订阅的主题（"inTopic"）上接收消息
2. 提取消息有效载荷
3. 将消息打印到串口监视器
4. 将相同的消息重新发布到 "youroutTopic"

## 配置参数

- **Host（主机）**: broker.emqx.io（公共测试代理）
- **Port（端口）**: 1883（标准 MQTT）
- **Keep-alive（保持连接）**: 120 秒（比基础示例更长，以提高稳定性）
- **Timeout（超时）**: 8000 毫秒（8 秒 - 更长以提高可靠性）
- **Client ID（客户端 ID）**: ty_test_id

## 重要设计说明

- **全局客户端引用**：客户端指针 `cli` 必须全局声明（在回调之前），以确保在回调函数中可访问
- **非阻塞重连**：循环检查连接状态，必要时重新连接
- **初始化顺序**：必须在初始化客户端之前设置回调函数

## 输出示例

连接时：
```
Connecting to your_ssid
...
WiFi connected
IP address: 
192.168.1.100
```

接收和转发消息时：
```
message: Hello from inTopic
（消息自动重新发布到 youroutTopic）
```

## 使用场景

- 在不同 MQTT 主题之间路由消息
- 数据转发和中继应用
- 构建 MQTT 桥接器
- 实现接收后发布的模式
- 创建通知系统

## 注意事项

- 本示例展示了在回调函数中发布消息的正确方法
- 在回调中使用时，客户端引用必须有效
- 重新发布时考虑速率限制，以避免消息循环
- 生产使用时，添加错误处理和连接监控
